# ALX Travel App (0x03): Background Jobs for Email Notifications

## Overview

This iteration (0x03) of the ALX Travel App significantly enhances performance and user experience by implementing asynchronous background task processing using **Celery with RabbitMQ** as the message broker. 
The core feature introduced is a robust email notification system that sends booking confirmations and payment confirmations without blocking the main request-response cycle. This ensures that users receive immediate feedback while time-consuming tasks like email dispatch are handled efficiently in the background, making the application more responsive and scalable.

## Features

*   **User Management:** Secure user registration, authentication (JWT), and profile management with distinct roles (Guest, Host, Admin).
    
*   **Property Listings:** Create, view, update, and delete property listings with detailed information (name, description, location, price per night).
    
*   **Booking System:** Users can book properties, and hosts can manage bookings for their properties.
    
*   **Reviews & Ratings:** Users can leave reviews and ratings for properties they have booked.
    
*   **Messaging System:** Threaded messaging for communication between users (e.g., guest-to-host).
    
*   **Chapa Payment Integration (from 0x02):** Secure payment initiation, verification, and status handling for bookings.
    
*   **Asynchronous Email Notifications (NEW):**
    
    *   **Celery Integration:** Configured with RabbitMQ to manage background tasks.
        
    *   **Booking Confirmation Emails:** Sent asynchronously upon successful booking creation.
        
    *   **Payment Confirmation Emails:** Sent asynchronously upon successful payment verification.
        
    *   **Non-blocking Operations:** Improves API responsiveness by offloading email sending.
        
    
*   **API Documentation:** Self-generating OpenAPI (Swagger UI/Redoc) documentation using drf-spectacular.
    

## Project Structure (Key Files)



    alx_travel_app_0x03/
    ├── .env.example              # Example .env file (for sensitive environment variables)
    ├── .gitignore                # Git ignore file
    ├── README.md                 # This documentation file
    ├── manage.py                 # Django's command-line utility
    ├── db.sqlite3                # SQLite database (for development, will be replaced by PostgreSQL)
    ├── schema.yml                # OpenAPI schema output (generated by drf-spectacular)
    ├── alx_travel_app/           # Django project root folder
    │   ├── __init__.py           # Package initializer, includes Celery app setup
    │   ├── settings.py           # Django settings, Chapa credentials, Celery/RabbitMQ config, Email Backend config
    │   ├── urls.py               # Main project URL configurations (admin, API, JWT, docs)
    │   └── celery.py             # Celery application instance definition
    └── listings/                 # Django app folder
        ├── __init__.py
        ├── admin.py
        ├── apps.py
        ├── migrations/           # Database migration files
        ├── models.py             # Defines Django models (User, Property, Booking, Payment, Review, Message)
        ├── serializers.py        # DRF serializers for API data validation and serialization
        ├── views.py              # DRF ViewSets for CRUD operations + Chapa payment views (now triggering Celery tasks)
        ├── urls.py               # App-specific URL patterns
        └── tasks.py              # NEW: Celery shared tasks for email notifications

## Setup and Installation

Follow these steps to get the project running on your local machine.

### Prerequisites

*   Python 3.8+
    
*   PostgreSQL
    
*   Docker (for running RabbitMQ)
    

### 1\. Clone the Repository



    git clone https://github.com/yourusername/alx_travel_app_0x03.git
    cd alx_travel_app_0x03

### 2\. Set Up a Virtual Environment

It's highly recommended to use a virtual environment to manage dependencies.

codeBash

    python3 -m venv venv
    source venv/bin/activate # On Windows: .\venv\Scripts\activate

### 3\. Install Dependencies

Install all required Python packages:



    pip install -r requirements.txt
    # If requirements.txt is not provided or updated, manually install:
    # pip install Django djangorestframework djangorestframework-simplejwt drf-spectacular psycopg2-binary python-dotenv requests celery pika

### 4\. Database Setup (PostgreSQL)

*   Create a PostgreSQL database and user.
    
    
    
        CREATE DATABASE alx_travel_app;
        CREATE USER alx_user WITH PASSWORD 'your_password';
        GRANT ALL PRIVILEGES ON DATABASE alx_travel_app TO alx_user;
    
*   Configure your DATABASES settings in alx\_travel\_app/alx\_travel\_app/settings.py to point to your PostgreSQL instance.
    

### 5\. Chapa API Credentials

*   **Create a Chapa Account:** Go to [https://developer.chapa.co/](https://www.google.com/url?sa=E&q=https%3A%2F%2Fdeveloper.chapa.co%2F) and sign up to obtain your **Test Secret Key** from your dashboard.
    
*   **Create/Update**  In the alx\_travel\_app/ directory (inside your project root, i.e., alx\_travel\_app\_0x03/alx\_travel\_app/.env), create or update the .env file.
    
*   Add your Chapa key:
    
    
    
        CHAPA_SECRET_KEY="sk_test_YOUR_CHAPA_TEST_SECRET_KEY"
    
**Important:** Ensure .env is listed in your .gitignore file to prevent committing sensitive information to your repository.
    

### 6\. RabbitMQ Setup

Start the RabbitMQ message broker using Docker. This command pulls the rabbitmq:3-management image, runs it as a container named some-rabbit, and maps the standard RabbitMQ port 5672 and the management UI port 15672 to your host machine.



    docker run -d --hostname my-rabbit --name some-rabbit -p 5672:5672 -p 15672:15672 rabbitmq:3-management

You can monitor the RabbitMQ management UI at http://localhost:15672 (default credentials: guest/guest).

### 7\. Configure Email Backend (in .env or settings.py)

For local development, using Django's console.EmailBackend is highly recommended as it prints email content to your terminal, allowing easy verification without sending actual emails. For production, you would switch to an SMTP backend.

**Example configuration in** 



    # ...
    EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend' # For development
    DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', 'noreply@alxtravelapp.com')
    # ...

**If using an SMTP server for production:**  
Update your .env file with your SMTP server details, and ensure settings.py reads them.



    # .env (example for production SMTP)
    EMAIL_HOST="smtp.your-email-provider.com"
    EMAIL_PORT=587
    EMAIL_USE_TLS="True" # Or "False" if using SSL and a different port
    EMAIL_HOST_USER="your_smtp_username"
    EMAIL_HOST_PASSWORD="your_smtp_password"
    # DEFAULT_FROM_EMAIL (as above)

### 8\. Run Database Migrations

Apply the database schema changes:



    python manage.py makemigrations
    python manage.py migrate

### 9\. Create a Superuser (Optional, for Admin Access)



    python manage.py createsuperuser

Follow the prompts to create an admin user for accessing the Django admin panel (http://127.0.0.1:8000/admin/).

### 10\. Start Celery Worker

In a **separate terminal window** from your Django server, navigate to your project root (alx\_travel\_app\_0x03/) and start the Celery worker:



    celery -A alx_travel_app worker -l info

This worker will connect to RabbitMQ and process background tasks (like sending emails). Keep this terminal open while testing.

### 11\. Start Django Development Server

In your main terminal window, start the Django server:



    python manage.py runserver

The API will now be accessible at http://127.0.0.1:8000/.

## API Endpoints

The API is self-documented using drf-spectacular. You can explore all endpoints, their schemas, and try them out via:

*   **Swagger UI:** http://127.0.0.1:8000/api/docs/
    
*   **Redoc:** http://127.0.0.1:8000/api/redoc/
    
*   **OpenAPI Schema:** http://127.0.0.1:8000/api/schema/
    

## How to Test Email Notifications

To verify that background email notifications are working correctly:

*   **Ensure all components are running:** RabbitMQ (in Docker), your Django server, and your Celery worker.
    
*   **Prepare Test Data:**
    
    *   Ensure you have at least one User and one Property created in your database (e.g., via the Django admin panel or your API endpoints for user registration and property creation).
        
    
*   **Create a New Booking:**
    
    *   Using an API client (like Postman, Insomnia) or curl, make a POST request to http://127.0.0.1:8000/api/bookings/.
        
    *   **Headers:** Include an Authorization: Bearer YOUR\_JWT\_TOKEN for an authenticated user.
        
    *   **Request Body (JSON):**
        
        
        
            {
                "property_id": "YOUR_PROPERTY_UUID",
                "user_id": "YOUR_USER_UUID",
                "start_date": "2025-09-10",
                "end_date": "2025-09-15"
                // `total_price` is read-only in the serializer, your backend logic should calculate it.
            }
        
    
*   **Observe Email Task Execution:**
    
    *   **Django Server Console:** You will see a DEBUG message confirming that the booking was created and that the send\_booking\_confirmation\_email task was triggered and added to the Celery queue. The Django server will respond quickly.
        
    *   **Celery Worker Console:** In the separate terminal running the Celery worker, you will see logs indicating that the send\_booking\_confirmation\_email task was received, processed, and completed.
        
        *   If EMAIL\_BACKEND is set to console.EmailBackend, the full content of the booking confirmation email (subject, recipient, and body) will be printed directly in this terminal window, confirming successful asynchronous dispatch.